<!DOCTYPE html>

<html>
    <head>
        <title>Drag and Drop examples</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style> 
#div1 {
    white-space: nowrap; 
    width: 12em; 
    overflow: hidden;
    text-overflow: clip; 
    border: 1px solid #000000;
}

#div2 {
    white-space: nowrap; 
    width: 12em; 
    overflow: hidden;
    text-overflow: ellipsis; 
    border: 1px solid #000000;
    border-radius: 5px;
}

</style>
        <style>
            body {
                background-color: white;
            }

            #outer {
                display: block;
            }

            div.framed {
                background-color: whitesmoke;
                border-style: solid;
                border-color: grey;
                border-width: 2px;
                border-radius: 10px;
                margin: 5px 5px 5px 5px;
                min-height: 100px;
                overflow:hidden;
            }           
            
            div.component {
                background-color: linen;
                margin: 4px 4px 4px 4px;
                float: left;
                border-style: solid;
                border-width: 1px;
                border-radius: 10px;
                border-color: grey;
                font-size: small;
                max-width: 130px;
                
            }

            div.label {
                text-align: center;
                white-space: nowrap; 
                overflow: hidden;
                text-overflow: ellipsis;
            }
        </style>
    </head>
    <body>
        <h1>More Wizzo Examples</h1>
        
        

        
        <div id="outer">
            <h2>Available files</h2>

            <div id="files" class="framed" title="Drop files here to load">

            </div>

            <h2>Calculation services</h2>
            <div id="services" class="framed">
            </div>

            <h2>Other actions</h2>
            <div id="otheractions" class="framed">
            </div>
        </div>

        <script>
            var mock = false;

            var mockDataItems = [
                {id: 1, name: "SDF 1", icon: "icons/Chemical-5-icon.png"},
                {id: 2, name: "SDF 2", icon: "icons/Cube-Molecule-2-icon.png"},
                {id: 3, name: "Document 23", icon: "icons/Document-icon.png"},
                {id: 4, name: "Document 501"},
                {id: 5, name: "SDF 6", icon: "icons/Cube-Molecule-icon.png"}
            ];

            var filesDiv = document.getElementById("files");
            filesDiv.addEventListener("dragenter", doNotHandle, false);
            filesDiv.addEventListener("dragover", doNotHandle, false);
            filesDiv.addEventListener("drop", dropFile, false);

            window.addEventListener("load", reLoadDataItems, false);
            window.addEventListener("dragover", doNotHandle, false);
            window.addEventListener("drop", doNotHandle, false);

            function reLoadDataItems() {


                while (filesDiv.hasChildNodes()) {
                    filesDiv.removeChild(filesDiv.lastChild);
                }

                console.log("Requesting data items");
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "/rest/files/list", true);
                xhr.overrideMimeType('text/plain; charset=x-user-defined-binary');
                xhr.onload = function (oEvent) {
                    console.log("xhr.onload()");
                    var status = xhr.status;
                    if (status === 200) {
                        var allData = JSON.parse(xhr.responseText);
                        console.log("received response");
                        addDataItems(allData);
                    }
                };
                xhr.send();
            }


            function addDataItems(dataItems) {

                for (var i = 0; i < dataItems.length; i++) {
                    var item = dataItems[i];
                    addDataItem(item)
                }
            }

            function addDataItem(item) {
                console.log("Ading data item " + item);
                var div = document.createElement("div");
                div.id = item.id;
                div.item = item;
                div.draggable = true;
                div.className = "component";
                div.title = item.name;
                var img = document.createElement("img");
                img.src = findIcon(item, "icons/Chemical-5-icon.png");
                img.draggable = false;
                div.appendChild(img);
                div.appendChild(document.createElement("br"));
                var label = document.createElement("div");
                label.className = "label";
                label.innerHTML = item.name;
                div.appendChild(label);
                filesDiv.appendChild(div);
                div.addEventListener('dragstart', dragstart, false);
            }

            var servicesItems = [
                {id: "Calculate LogP", description: "Calculate LogP", path: "/process", endpoint: "direct:logp", icon: "icons/Programming-Add-Property-icon.png"},
                {id: "Lipinski props", description: "", path: "/process", endpoint: "direct:lipinski", icon: "icons/Programming-Add-Property-icon.png"},
                {id: "Drug like filter", path: "/process", endpoint: "direct:filter_example", icon: "icons/Filter-List-icon.png"},
                {id: "ECFP4 screen", endpoint: "direct:screening/ecfp", icon: "icons/Filter-List-icon.png"},
                {id: "Pharmacophore screen", endpoint: "direct:screening/pharmacophore", icon: "icons/Filter-List-icon.png"},
                {id: "Spherex Clustering", endpoint: "clustering/spherex/ecfp4"}
            ];

            var servicesDiv = document.getElementById("services");
            for (var i = 0; i < servicesItems.length; i++) {
                var item = servicesItems[i];
                var div = document.createElement("div");
                div.id = item.id;
                div.item = item;
                div.className = "component droptarget";
                var img = document.createElement("img");
                img.src = findIcon(item, "icons/Very-Basic-Services-icon.png");
                img.draggable = false;
                div.appendChild(img);
                div.appendChild(document.createElement("br"));
                var label = document.createElement("div");
                label.className = "label";
                label.innerHTML = item.id;
                div.appendChild(label);
                servicesDiv.appendChild(div);
                div.addEventListener("dragenter", doNotHandle, false);
                div.addEventListener("dragover", doNotHandle, false);
                div.addEventListener("drop", dropOntoService, false);
            }

            var otherActionItems = [
                {id: "Delete", path: "/files/delete", icon: "icons/Household-Waste-icon.png"},
                {id: "Export", icon: "icons/export-icon.png"},
                {id: "View", icon: "icons/spreadsheet-icon.png"}
            ];

            var servicesDiv = document.getElementById("otheractions");
            for (var i = 0; i < otherActionItems.length; i++) {
                var item = otherActionItems[i];
                var div = document.createElement("div");
                div.id = item.id;
                div.item = item;
                div.className = "component droptarget";
                var img = document.createElement("img");
                img.src = findIcon(item, "icons/Very-Basic-Services-icon.png");
                img.draggable = false;
                div.appendChild(img);
                div.appendChild(document.createElement("br"));
                var label = document.createElement("div");
                label.className = "label"
                label.innerHTML = item.id;
                div.appendChild(label);
                servicesDiv.appendChild(div);
                div.addEventListener("dragenter", doNotHandle, false);
                div.addEventListener("dragover", doNotHandle, false);
                div.addEventListener("drop", dropOntoService, false);
            }

            function findIcon(obj, defaultIcon) {
                var src = obj.icon;
                if (src === undefined) {
                    return defaultIcon;
                } else {
                    return src;
                }
            }

            function dragstart(e) {
                // store the ID of the element, and collect it on the drop later on
                console.log("drag start for " + e.target.id)
                e.dataTransfer.setData('Text', e.target.id);
            }

            function doNotHandle(e) {
                e.stopPropagation();
                e.preventDefault();
            }

            function dropOntoService(e) {
                e.stopPropagation();
                e.preventDefault();

                var serviceDiv = findDropDiv(e.target, "droptarget");
                var service = serviceDiv.item;
                var path = service.path;
                if (path === undefined) {
                    alert("Service not yet implemented");
                    return;
                }

                var dt = e.dataTransfer;

                var dataId = dt.getData('Text');


                console.log("Dropped " + dataId + " onto " + serviceDiv.id + "[" + service.endpoint + "]");

                var xhr = new XMLHttpRequest();
                xhr.open("POST", path, true);
                xhr.onload = function () {
                    var status = xhr.status;
                    if (status === 200) {
                        console.log("Processing OK");
                        var json = xhr.response;
                        if (json) {
                            var item = JSON.parse(json);
                            addDataItem(item);
                        } else {
                            reLoadDataItems();
                        }
                    } else {
                        alert("Processing failed");
                    }
                };
                var formData = new FormData();
                formData.append("item", dataId);
                if (service.endpoint) {
                    formData.append("endpoint", service.endpoint);
                }
                xhr.send(formData);

                return false;
            }

            function dropFile(e) {
                console.log("File dropped?")
                e.stopPropagation();
                e.preventDefault();
                var files = e.dataTransfer.files; // Array of all files
                //for (var i = 0, file; file = files[i]; i++) {
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    var name = file.name;
                    console.log("Dropped file 1 " + name + " - " + file);

                    var formData = new FormData();
                    formData.append('file', file, file.name);

                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", "/files/upload", true);
                    xhr.onload = function () {
                        var status = xhr.status;
                        if (status === 200) {
                            var json = xhr.response;
                            var results = JSON.parse(json);
                            addDataItems(results);
                        } else {
                            alert("File load failed");
                        }
                    };
                    xhr.send(formData);
                }
                return false;
            }

            function findDropDiv(target, cls) {
                if (target.classList.contains(cls)) {
                    return target;
                } else if (target.parentNode === undefined) {
                    return null;
                } else {
                    return findDropDiv(target.parentNode, cls);
                }
            }
        </script>
    </body>
</html>
