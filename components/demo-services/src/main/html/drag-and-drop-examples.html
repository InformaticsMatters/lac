<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Workflow examples</title>

        <style>
            .glasspane {
                z-index: 999;
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                display: none;
                position: absolute;				
                background: rgba(0,0,0,.5);
            }
            .popup {
                z-index: 1000;
                position: absolute;
                background-color: white;
                border-style: solid;
                border-color: darkgrey;
                border-width: 4px;
                /* To align popup window at the center of screen*/
                top: 50%;
                left: 50%;
            }

            #progress {
                z-index: 1000;
                position: absolute;
                background-color: white;
                border-style: solid;
                border-color: darkgrey;
                border-width: 4px;
                top: 0%;
                left: 0%;

            </style>

            <script type="text/javascript">
                function pop(div) {
                    document.getElementById(div).style.display = 'block';
                }
                function hide(div) {
                    document.getElementById(div).style.display = 'none';
                }
            </script>

            <style type="text/css">

                body {
                    margin:0;
                    padding:0;
                    background: whitesmoke;
                }

                #topsection {
                    height: 50px; /*Height of top section*/
                }

                #topsection h1 {
                    margin: 0;
                    padding-top: 15px;
                }

                #contentwrapper {
                    float: left;
                    width: 100%;
                }

                #contentcolumn {
                    margin: 0 180px 0 120px; /*Margins for content column. Should be "0 RightColumnWidth 0 LeftColumnWidth*/
                    padding: 5px;
                }

                #leftcolumn {
                    float: left;
                    width: 110px; /*Width of left column*/
                    margin-left: -100%;
                    padding: 5px;
                }

                #workflowcolumn {
                    float: left;
                    width: 170px; /*Width of right column*/
                    margin-left: -180px; /*Set left marginto -(RightColumnWidth)*/
                    padding: 5px;
                }

                #leftcontent {
                    min-height: 500px;
                }

                #workflowcontent {
                    min-height: 500px;
                }

                #queries {
                    min-height: 100px;
                } 

                #files {
                    min-height: 100px;
                } 

                #services {
                    min-height: 100px;
                } 

                .boxed {
                    background-color: white;
                    border-style: solid;
                    border-color: grey;
                    border-width: 2px;
                    padding: 2px 2px 2px 2px;
                    overflow: scroll;
                }

                #footer{
                    //position: fixed;
                    //bottom: 0px;
                    clear: left;
                    width: 100%;
                    //background: black;
                    //color: #FFF;
                    text-align: center;
                    padding: 4px 0px;
                }

                .innertube {
                    margin: 10px; /*Margins for inner DIV inside each column (to provide padding)*/
                    margin-top: 0;
                }

                div.component {
                    display: block;
                    margin: 2px 2px 2px 2px;
                    padding: 0px;
                    border-style: solid;
                    border-width: 2px;
                    border-radius: 6px;
                    font-size: smaller;
                }

                div.info {
                    font-size: smaller;
                    text-align: right;
                    color: grey;
                }

                //div.content img {
                //    float:left;
                //}

                div.palette div.component {
                    float: left;
                }

                div.workflowcontent div {
                    display: block;
                    margin-top: 0px;
                    margin-bottom: 0px;
                    margin-left: auto;
                    margin-right: auto;
                    overflow: hidden;

                }

                div.query {
                    background-color: lightcyan;
                    border-color: cyan;
                    width: 100px;
                }

                div.query div.title {
                    background: cyan;
                    color: black;
                }

                div.dataitem {
                    background-color: lavender;
                    border-color: cornflowerblue;
                    width: 100px;
                }

                div.dataitem div.title {
                    background: cornflowerblue;
                    color: white;
                }

                div.service {
                    background-color: linen;
                    border-color: orange;
                    width: 100px;
                }

                div.service div.title {
                    background: orange;
                    color: white;
                }

                div.action {
                    background-color: whitesmoke;
                    border-color: black;
                    width: 85px;
                    margin-left: auto;
                    margin-right: auto;
                }

                div.action div.title {
                    background: black;
                    color: white;
                }

                .component.over {
                    border-width: 4px;
                    margin: 0px;
                }

                .workflowarrow {
                    display: block;
                    margin-top: 0px;
                    margin-bottom: 0px;
                    margin-left: auto;
                    margin-right: auto;
                }

                div.title {
                    text-align: center;
                    white-space: nowrap; 
                    overflow: hidden;
                    text-overflow: ellipsis;
                    margin: 0px;
                    padding: 0px;
                    font-size: small;               
                }

                div.content {
                    margin: 1px;
                }

            </style>

        </head>
        <body>
            <div id="maincontainer">

                <div id="topsection"><div class="innertube"><h1>Workflow examples</h1></div></div>

                <div id="contentwrapper">
                    <div id="contentcolumn">
                        <div class="innertube boxed"><b>Queries</b>
                            <div id="queries" class="palette">
                            </div>
                        </div>
                        <div class="innertube boxed"><b>Data sets</b>
                            <div id="files" class="palette" title="Drop files here to load">
                            </div>
                        </div>
                        <div class="innertube boxed"><b>Services</b> 
                            <div id="services" class="palette">
                            </div>
                        </div>

                    </div>

                </div>

                <div id="leftcolumn">
                    <div id="leftcontent" class="boxed">
                        <div><b>Actions</b> </div>
                        <div id="actions">
                        </div>
                    </div>
                </div>

                <div id="workflowcolumn">
                    <div id="workflow" class="boxed">
                        <div><b>Workflow</b></div>
                        <div id="workflowcontent" class="workflowcontent">
                        </div>
                    </div>
                </div>

                <!--div id="footer">Footer here</div-->

            </div>

            <script>



                function createComponentDiv(item, icon, desc) {
                    var div = document.createElement("div");
                    div.id = item.id;
                    div.draggable = true;

                    var img = document.createElement("img");
                    img.src = icon;
                    img.draggable = false;
                    img.width = 48;
                    img.height = 48;
                    img.align = "left";

                    var title = document.createElement("div");
                    title.className = "title";
                    title.innerHTML = item.name;

                    var content = document.createElement("div");
                    content.className = "content";
                    var info = document.createElement("div");
                    info.className = "info";
                    if (desc !== undefined) {
                        info.innerHTML = desc;
                    }
                    content.appendChild(img);
                    content.appendChild(info);
                    div.appendChild(title);
                    div.appendChild(content);
                    return div;
                }

                function createActionDiv(item, icon) {
                    var div = document.createElement("div");
                    div.id = item.id;
                    div.draggable = false;

                    var img = document.createElement("img");
                    img.src = icon;
                    img.draggable = false;
                    img.width = 48;
                    img.height = 48;

                    var title = document.createElement("div");
                    title.className = "title";
                    title.innerHTML = item.name;
                    div.appendChild(title);
                    div.appendChild(img);
                    return div;
                }


                var filesDiv = document.getElementById("files");
                var workflowDiv = document.getElementById("workflowcontent");
                filesDiv.addEventListener("dragenter", doNotHandle, false);
                filesDiv.addEventListener("dragover", doNotHandle, false);
                filesDiv.addEventListener("drop", handleDropOntoDataItems, false);
                workflowDiv.addEventListener("dragenter", doNotHandle, false);
                workflowDiv.addEventListener("dragover", doNotHandle, false);
                workflowDiv.addEventListener("drop", dropOntoWorkflow, false);
                window.addEventListener("load", reLoadDataItems, false);
                window.addEventListener("dragover", doNotHandle, false);
                window.addEventListener("drop", doNotHandle, false);


                var queriesItems = [
//                    {id: "emols_sc",
//                        name: "eMols screening cpds",
//                        info: "6056409",
//                        popup: "structure-query-submit",
//                        form: "structure-query-submit-form",
//                        path: "/chemsearch",
//                        endpoint: "direct:chemsearch/emolecules_sc"},
                    {id: "emols_bb",
                        name: "eMols building blocks",
                        info: "818887",
                        popup: "structure-query-submit",
                        form: "structure-query-submit-form",
                        path: "/chemsearch",
                        endpoint: "direct:chemsearch/emolecules_bb"},
                    {id: "drugbank",
                        name: "DrugBank",
                        info: "3401",
                        popup: "structure-query-submit",
                        form: "structure-query-submit-form",
                        path: "/chemsearch",
                        endpoint: "direct:chemsearch/drugbank"}
                ];

                var queriesDiv = document.getElementById("queries");
                for (var i = 0; i < queriesItems.length; i++) {
                    var query = queriesItems[i];

                    var div = createComponentDiv(query, findIcon(query, "icons/Misc-Database-3-icon.png"), query.info);
                    div.query = query;
                    div.className = "component query";

                    queriesDiv.appendChild(div);

                    div.addEventListener("dragenter", handleDragEnter, false);
                    div.addEventListener("dragleave", handleDragLeave, false);
                    div.addEventListener("dragover", doNotHandle, false);
                    div.addEventListener('dragstart', function (e) {
                        e.dataTransfer.setData('QueryID', e.target.id);
                    }, false);
                }


                function reLoadDataItems() {
                    while (filesDiv.hasChildNodes()) {
                        filesDiv.removeChild(filesDiv.lastChild);
                    }

                    console.log("Requesting data items");
                    var xhr = new XMLHttpRequest();
                    xhr.open("GET", "/rest/files", true);
                    xhr.overrideMimeType('text/plain; charset=x-user-defined-binary');
                    xhr.onload = function (oEvent) {
                        console.log("xhr.onload()");
                        var status = xhr.status;
                        if (status === 200) {
                            var allData = JSON.parse(xhr.responseText);
                            console.log("received response");
                            addDataItems(allData);
                        }
                    };
                    xhr.send();
                }


                function addDataItems(dataItems) {
                    for (var i = 0; i < dataItems.length; i++) {
                        var item = dataItems[i];
                        addDataItem(item);
                    }
                }

                function addDataItem(item) {
                    console.log("Adding data item ID= " + item.id + " name=" + item.name);

                    var info = item.size;

                    var div = createComponentDiv(item, findIcon(item, "icons/Chemical-5-icon.png"), info);

                    div.item = item;
                    div.className = "component dataitem droptarget";

                    filesDiv.appendChild(div);
                    console.log("Item added");
                    div.addEventListener("dragenter", handleDragEnter, false);
                    div.addEventListener("dragleave", handleDragLeave, false);
                    div.addEventListener('dragstart', function (e) {
                        e.dataTransfer.setData('DataItemID', e.target.id);
                    }, false);
                    div.addEventListener("drop", dropOntoDataItem, false);
                }


                var servicesItems = [
                    {id: "calcLogP",
                        name: "Calculate LogP",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:logp",
                        icon: "icons/Programming-Add-Property-icon.png"},
                    {id: "calcLipinski",
                        name: "Lipinski props",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:lipinski",
                        icon: "icons/Programming-Add-Property-icon.png"},
                    {id: "drugLikeFilter",
                        name: "Drug like filter",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:filter_example",
                        icon: "icons/Filter-List-icon.png"},
                    {id: "ecfpScreen",
                        name: "ECFP4 screen",
                        popup: "screening-service-submit",
                        form: "screening-service-submit-form",
                        path: "/process",
                        endpoint: "direct:screening/ecfp",
                        icon: "icons/Filter-List-icon.png"},
                    {id: "pharmacophoreScreen",
                        name: "Pharmacophore screen",
                        popup: "screening-service-submit",
                        form: "screening-service-submit-form",
                        path: "/process",
                        endpoint: "direct:screening/pharmacophore",
                        icon: "icons/Filter-List-icon.png"},
                    {id: "spherexClust",
                        name: "Spherex Clustering",
                        popup: "spherex-clustering-service-submit",
                        form: "spherex-clustering-service-submit-form",
                        path: "/process",
                        endpoint: "direct:clustering/spherex/ecfp4"}
                ];

                var servicesDiv = document.getElementById("services");
                for (var i = 0; i < servicesItems.length; i++) {
                    var service = servicesItems[i];

                    var div = createComponentDiv(service, findIcon(service, "icons/Very-Basic-Services-icon.png"));
                    div.service = service;
                    div.className = "component service droptarget";

                    servicesDiv.appendChild(div);

                    div.addEventListener("dragenter", handleDragEnter, false);
                    div.addEventListener("dragleave", handleDragLeave, false);
                    div.addEventListener("dragover", doNotHandle, false);
                    div.addEventListener("drop", dropOntoService, false);
                    div.addEventListener('dragstart', function (e) {
                        e.dataTransfer.setData('ServiceID', e.target.id);
                    }, false);
                }


                var otherActionItems = [
                    {id: "delete",
                        name: "Delete",
                        handler: handleFileDelete,
                        icon: "icons/Household-Waste-icon.png"},
                    {id: "export",
                        name: "Export",
                        path: "/files/download",
                        handler: handleFileDownload,
                        icon: "icons/export-icon.png"},
                    {id: "view",
                        name: "View",
                        icon: "icons/spreadsheet-icon.png"}
                ];

                var actionsDiv = document.getElementById("actions");
                for (var i = 0; i < otherActionItems.length; i++) {
                    var service = otherActionItems[i];

                    var div = createActionDiv(service, findIcon(service, "icons/Very-Basic-Services-icon.png"));
                    div.service = service;
                    div.className = "component action droptarget";
                    div.draggable = false;

                    actionsDiv.appendChild(div);
                    div.addEventListener("dragenter", handleDragEnter, false);
                    div.addEventListener("dragleave", handleDragLeave, false);
                    div.addEventListener("dragover", doNotHandle, false);
                    var dropHandler = service.handler;
                    if (dropHandler === undefined) {
                        dropHandler = dropOntoService;
                    }
                    div.addEventListener("drop", dropHandler, false);
                }

                function findIcon(obj, defaultIcon) {
                    var src = obj.icon;
                    if (src === undefined) {
                        return defaultIcon;
                    } else {
                        return src;
                    }
                }

                function doNotHandle(e) {
                    e.stopPropagation();
                    e.preventDefault();
                }

                function handleDragEnter(e) {
                    this.classList.add('over');
                }

                function handleDragLeave(e) {
                    this.classList.remove('over');
                }

                function dropOntoWorkflow(e) {
                    console.log("Item dropped onto workflow");
                    e.stopPropagation();
                    e.preventDefault();
                    var dt = e.dataTransfer;
                    var serviceID = dt.getData('ServiceID');
                    var dataItemID = dt.getData('DataItemID');
                    var queryID = dt.getData('QueryID');
                    if (serviceID.length > 0) {
                        console.log("Handling service " + serviceID);
                        handleWorkflowDropService(serviceID);
                    } else if (dataItemID.length > 0) {
                        console.log("handling data item " + dataItemID);
                        handleWorkflowDataItem(dataItemID);
                    } else if (queryID.length > 0) {
                        console.log("handling query ") + queryID;
                        handleWorkflowQuery(queryID);
                    }
                }

                function handleWorkflowQuery(queryID) {
                    console.log("Handling workflow query " + queryID);
                    var queryDiv = document.getElementById(queryID);
                    var query = queryDiv.query;

                    var div = createComponentDiv(query, findIcon(query, "icons/Misc-Database-3-icon.png"), query.info);
                    div.query = query;
                    div.className = "component query";
                    div.draggable = false; // this need to change to allow rearrangement                    

                    workflowDiv.appendChild(div);
                }

                function handleWorkflowDataItem(dataItemID) {
                    console.log("Handling workflow data item " + dataItemID);
                    var dataItemDiv = document.getElementById(dataItemID);
                    var dataItem = dataItemDiv.item;

                    var div = createComponentDiv(dataItem, findIcon(dataItem, "icons/Chemical-5-icon.png"), dataItem.size);
                    div.item = dataItem;
                    div.className = "component dataitem";
                    div.draggable = false; // this need to change to allow rearrangement                    

                    workflowDiv.appendChild(div);
                }

                function handleWorkflowDropService(serviceID) {
                    console.log("Handling workflow service " + serviceID);
                    var serviceDiv = document.getElementById(serviceID);
                    var arrow = document.createElement("img");
                    arrow.src = "icons/Down-Arrow-icon.png";
                    arrow.draggable = false;
                    arrow.width = 32;
                    arrow.height = 32;
                    arrow.align = "middle";
                    arrow.className = "workflowarrow";
                    var arrowDiv = document.createElement("div");
                    arrowDiv.appendChild(arrow);
                    workflowDiv.appendChild(arrowDiv);

                    var service = serviceDiv.service;
                    var div = createComponentDiv(service, findIcon(service, "icons/Very-Basic-Services-icon.png"));
                    div.service = service;
                    div.className = "component service ";
                    div.draggable = false; // this need to change to allow rearrangement

                    workflowDiv.appendChild(div);
                }

                function dropOntoDataItem(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    this.classList.remove('over');
                    var dataItemDiv = findDropDiv(e.target, "droptarget");
                    if (dataItemDiv === undefined) {
                        console.log("Data item not found");
                        return;
                    }
                    var dt = e.dataTransfer;
                    var serviceId = dt.getData('ServiceID');
                    var serviceDiv = document.getElementById(serviceId);
                    if (serviceDiv === undefined) {
                        console.log("Service not found");
                        return;
                    }
                    console.log("Dropped " + serviceDiv.id + " onto " + dataItemDiv.id);
                    console.log("Data item is " + dataItemDiv.item);
                    console.log("Service is " + serviceDiv.service);
                    handleDataItemServiceDrop(dataItemDiv.item, serviceDiv.service);
                    return false;
                }

                /*
                 * This needs handling better.
                 */
                function handleFileDownload(e) {
                    console.log("Handling file download");
                    e.stopPropagation();
                    e.preventDefault();
                    this.classList.remove('over');

                    var dt = e.dataTransfer;
                    var dataId = dt.getData('DataItemID');
                    if (dataId === undefined) {
                        console.log("No DataItem defined");
                        return;
                    }
                    window.open("/rest/files/" + dataId);
                    return false;
                }


                function handleFileDelete(e) {
                    console.log("Handling file delete");
                    e.stopPropagation();
                    e.preventDefault();
                    this.classList.remove('over');

                    var dt = e.dataTransfer;
                    var dataId = dt.getData('DataItemID');
                    if (dataId === undefined) {
                        console.log("No DataItem defined");
                        return;
                    }
                    var xhr = new XMLHttpRequest();
                    xhr.open("DELETE", "/rest/files/" + dataId, true);
                    xhr.onload = function () {
                        hide("progress");
                        var status = xhr.status;
                        if (status === 200) {
                            console.log("Processing OK");
                            var div = document.getElementById(dataId);
                            div.parentNode.removeChild(div);
                        } else {
                            alert("Delete failed");
                        }
                    };
                    xhr.send();
                    return false;
                }

                function dropOntoService(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    this.classList.remove('over');
                    var serviceDiv = findDropDiv(e.target, "droptarget");
                    var dt = e.dataTransfer;
                    var dataId = dt.getData('DataItemID');
                    var itemDiv = document.getElementById(dataId);
                    handleDataItemServiceDrop(itemDiv.item, serviceDiv.service);
                    return false;
                }

                function handleDataItemServiceDrop(dataItem, service) {
                    console.log("Running service " + service.id + " for data " + dataItem.name);
                    var path = service.path;
                    if (path === undefined) {
                        alert("Service not yet implemented");
                        return;
                    }
                    var formName = service.form;
                    if (formName === undefined) {
                        var noParamsForm = document.getElementById("no-params-service-submit");
                        populateServiceRequestForm(noParamsForm, dataItem, service);
                        handleServiceRequest("no-params-service-submit");
                    } else {
                        var form = document.getElementById(service.form);
                        populateServiceRequestForm(form, dataItem, service);
                        console.log("Showing popup");
                        pop(service.popup);
                        console.log("Popup handled");
                    }
                }

                function handleServiceRequest(formId) {
                    var form = document.getElementById(formId);
                    console.log("Form ID is " + formId + ", form is " + form);
                    var formData = new FormData();
                    var path;
                    for (var i = 0; i < form.elements.length; i++) {
                        var el = form.elements[i];
                        console.log("Handling element " + el.name);
                        if (el.name === "inputName") {
                            // do nothing
                        } else if (el.name === "itemId") {
                            formData.append("item", el.value);
                            console.log("Item ID set to " + el.value);
                        } else if (el.name === "serviceEndpoint") {
                            formData.append("endpoint", el.value);
                            console.log("Endpoint set to " + el.value);
                        } else if (el.name === "outputName") {
                            formData.append("itemName", el.value);
                            console.log("New name set to " + el.value);
                        } else if (el.name === "path") {
                            path = el.value;
                            console.log("Path set to " + el.value);
                        } else if (el.name !== undefined) {
                            formData.append(el.name, el.value);
                            console.log(el.name + " set to " + el.value);
                        }

                    }
                    if (path === undefined) {
                        return;
                    }

                    var prog = createProgress("Processing");
                    pop("progress");

                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", path, true);
                    xhr.onload = function () {
                        handlePostForDataItems(xhr);
                    };
                    console.log("Posting request to " + path);
                    xhr.send(formData);
                }

                function handlePostForDataItems(xhr) {
                    hide("progress");
                    var status = xhr.status;
                    if (status === 200) {
                        console.log("Processing OK");
                        var json = xhr.response;
                        console.log("JSON: " + json);
                        if (json === undefined || json.length === 0) {
                            // no response so nothing to do
                        } else {
                            console.log("Response JSON: " + json);
                            var items = JSON.parse(json);
                            if (items.length > 0) {
                                console.log("Adding items");
                                addDataItems(items);
                            } else {
                                alert("No results!");
                            }
                        }
                    } else {
                        alert("Processing failed");
                    }
                }

                function createProgress(name, max) {
                    var div = document.getElementById("progress");
                    while (div.hasChildNodes()) {
                        div.removeChild(div.lastChild);
                    }
                    var span = document.createElement("span");
                    span.innerHTML = name + ":&nbsp;";
                    div.appendChild(span);
                    var prog = document.createElement("progress");
                    div.appendChild(prog);
                    if (max !== undefined) {
                        prog.max = max;
                        prog.value = 0;
                    }
                    return prog;
                }

                function handleDropOntoDataItems(e) {

                    e.stopPropagation();
                    e.preventDefault();
                    if (e.dataTransfer.files !== undefined && e.dataTransfer.files.length > 0) {
                        console.log("File dropped");
                        handleDropFiles(e);
                    } else if (e.dataTransfer.getData('QueryID') !== undefined) {
                        console.log("Query dropped");
                        handleDropQueryOntoDataItems(e);
                    } else {
                        console.log("Unrecognised drop");
                    }
                }

                function handleDropQueryOntoDataItems(e) {
                    var dt = e.dataTransfer;
                    var queryId = dt.getData('QueryID');
                    var queryDiv = document.getElementById(queryId);
                    var query = queryDiv.query;
                    var form = document.getElementById(query.form);
                    setFormProperty(form, "queryName", query.name);
                    setFormProperty(form, "queryId", query.id);
                    setFormProperty(form, "outputName", "");
                    pop(query.popup);

                }

                function handleQueryRequest(formId) {
                    var form = document.getElementById(formId);
                    console.log("Form ID " + formId + " is " + form);
                    var formData = new FormData();

                    //serviceEndpoint path queryStructure searchOptions outputName
                    var els = form.elements;
                    var queryId = els['queryId'].value;
                    var query = document.getElementById(queryId).query;

                    var path = query.path;
                    formData.append("endpoint", query.endpoint);
                    formData.append("QueryStructure", els['queryStructure'].value);
                    formData.append("JChemSearchOptions", els['searchOptions'].value);
                    formData.append("itemName", els['outputName'].value);

                    createProgress("Processing");
                    pop("progress");

                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", path, true);
                    xhr.onload = function () {
                        hide("progress");
                        handlePostForDataItems(xhr);
                    };
                    console.log("Posting request to " + path);
                    xhr.send(formData);

                }

                function handleDropFiles(e) {

                    var files = e.dataTransfer.files; // Array of all files
                    for (var i = 0; i < files.length; i++) {
                        var prog = createProgress("File upload", 100);
                        pop("progress");
                        var file = files[i];
                        var name = file.name;
                        console.log("Dropped file 1 " + name + " - " + file);
                        var formData = new FormData();
                        formData.append('file', file, file.name);
                        var xhr = new XMLHttpRequest();
                        xhr.open("POST", "/files/upload", true);
                        xhr.onload = function () {
                            hide("progress");
                            var status = xhr.status;
                            if (status === 200) {
                                var json = xhr.response;
                                var results = JSON.parse(json);
                                addDataItems(results);
                            } else {
                                alert("File load failed");
                            }
                        };
                        xhr.upload.addEventListener("progress", function (e) {
                            if (e.lengthComputable) {
                                var percentage = Math.round((e.loaded * 100) / e.total);
                                console.log("Progress: " + e + " | " + percentage);
                                prog.value = percentage;
                            }
                        }, false);
                        xhr.upload.addEventListener("load", function (e) {
                            prog.value = 100;
                            prog = createProgress("Processing");
                        }, false);
                        xhr.upload.addEventListener("error", function (e) {
                            hide("progress");
                            altert("Error encountered uploading file");
                        }, false);
                        xhr.send(formData);
                    }
                    return false;
                }

                function findDropDiv(target, cls) {
                    if (target === undefined) {
                        return null;
                    } else if (target.classList.contains(cls)) {
                        return target;
                    } else if (target.parentNode === undefined) {
                        return null;
                    } else {
                        return findDropDiv(target.parentNode, cls);
                    }
                }

                function populateServiceRequestForm(form, item, service) {
                    form.reset();
                    setFormProperty(form, "path", service.path);
                    setFormProperty(form, "serviceEndpoint", service.endpoint);
                    setFormProperty(form, "serviceName", service.id);
                    setFormProperty(form, "inputName", item.name);
                    setFormProperty(form, "itemId", item.id);
                    setFormProperty(form, "outputName", "");
                }

                function setFormProperty(form, propName, value) {
                    if (form[propName] !== undefined) {
                        form[propName].value = value;
                    }
                }
            </script>

            <div id="basic-params-service-submit" class="glasspane">
                <div class="popup" style="width: 300px; height: 200px; margin-top: -100px; margin-left: -150px;">
                    <div style="text-align: right;">
                        <a href="#" onClick="hide('basic-params-service-submit')">X</a>
                    </div>
                    <div>
                        <form id="basic-service-submit-form">
                            <input type="text" name="itemId" hidden disabled>
                            <input type="text" name="serviceEndpoint" hidden disabled>
                            <input type="text" name="path" hidden disabled>
                            <div>
                                <table cellpadding="3">
                                    <tr><td>Service:</td><td><input type="text" name="serviceName" size="20" disabled value=""></td></tr>
                                    <tr><td>Name of input:</td><td><input type="text" name="inputName" size="20" disabled value=""></td></tr>
                                    <tr><td>Name of output:</td><td><input type="text" name="outputName" size="20" value="" autofocus></td></tr>
                                </table>
                            </div>
                            <div style="position:absolute; right: 10px; bottom: 10px;">
                                <button type="button" onclick="hide('basic-params-service-submit');
                                        handleServiceRequest('basic-service-submit-form')">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="spherex-clustering-service-submit" class="glasspane">
                <div class="popup" style="width: 300px; height: 200px; margin-top: -100px; margin-left: -150px;">
                    <div style="text-align: right;">
                        <a href="#" onClick="hide('spherex-clustering-service-submit')">X</a>
                    </div>
                    <div>
                        <form id="spherex-clustering-service-submit-form">
                            <input type="text" name="itemId" hidden disabled>
                            <input type="text" name="serviceEndpoint" hidden disabled>
                            <input type="text" name="path" hidden disabled>
                            <div>
                                <table cellpadding="3">
                                    <tr><td>Service:</td><td><input type="text" name="serviceName" size="20" disabled value=""></td></tr>
                                    <tr><td>Name of input:</td><td><input type="text" name="inputName" size="20" disabled value=""></td></tr>
                                    <tr><td>Name of output:</td><td><input type="text" name="outputName" size="20" value="" autofocus></td></tr>
                                    <tr><td>Min clusters:</td><td><input type="text" name="MinClusterCount" size="5" value="5"></td></tr>
                                    <tr><td>Max clusters:</td><td><input type="text" name="MaxClusterCount" size="5" value="10"></td></tr>
                                </table>
                            </div>
                            <div style="position:absolute; right: 10px; bottom: 10px;">
                                <button type="button" onclick="hide('spherex-clustering-service-submit');
                                        handleServiceRequest('spherex-clustering-service-submit-form');">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="screening-service-submit" class="glasspane">
                <div class="popup" style="width: 400px; height: 200px; margin-top: -100px; margin-left: -200px;">
                    <div style="text-align: right;">
                        <a href="#" onClick="hide('screening-service-submit')">X</a>
                    </div>
                    <div>
                        <form id="screening-service-submit-form">
                            <input type="text" name="itemId" hidden disabled>
                            <input type="text" name="serviceEndpoint" hidden disabled>
                            <input type="text" name="path" hidden disabled>
                            <div>
                                <table cellpadding="3">
                                    <tr><td>Service:</td><td><input type="text" name="serviceName" size="20" disabled value=""></td></tr>
                                    <tr><td>Name of input:</td><td><input type="text" name="inputName" size="20" disabled value=""></td></tr>
                                    <tr><td>Name of output:</td><td><input type="text" name="outputName" size="20" value="" autofocus></td></tr>
                                    <tr><td>Target structure:</td><td><input type="text" name="TargetMolecule" size="40" value="NC1=CC=CC(NC2=NC=CC=N2)=C1"></td></tr>
                                    <tr><td>Threshold:</td><td><input type="text" name="Threshold" size="5" value="0.8"></td></tr>
                                </table>
                            </div>
                            <div style="position:absolute; right: 10px; bottom: 10px;">
                                <button type="button" onclick="hide('screening-service-submit');
                                        handleServiceRequest('screening-service-submit-form');">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>


            <div id="structure-query-submit" class="glasspane">
                <div class="popup" style="width: 400px; height: 200px; margin-top: -100px; margin-left: -200px;">
                    <div style="text-align: right;">
                        <a href="#" onClick="hide('structure-query-submit')">X</a>
                    </div>
                    <div>
                        <form id="structure-query-submit-form">
                            <input type="text" name="queryId" hidden disabled>
                            <div>
                                <table cellpadding="3">
                                    <tr><td>Database:</td><td><input type="text" name="queryName" size="40" disabled value=""></td></tr>
                                    <tr><td>Query structure:</td><td><input type="text" name="queryStructure" size="40" value="NC1=CC=CC(NC2=NC=CC=N2)=C1"></td>     
                                    <tr><td>Search type:</td><td>
                                            <select name="searchOptions">
                                                <option value="t:s">Substructure</option>
                                                <option value="t:i dissimilarityThreshold:0.1">90% Similarity</option>
                                                <option value="t:i dissimilarityThreshold:0.2">80% Similarity</option>
                                                <option value="t:i dissimilarityThreshold:0.3">70% Similarity</option>
                                            </select></td></tr>
                                    <tr><td>Name of output:</td><td><input type="text" name="outputName" size="20" value="" autofocus></td></tr>
                                </table>
                            </div>
                            <div style="position:absolute; right: 10px; bottom: 10px;">
                                <button type="button" onclick="hide('structure-query-submit');
                                        handleQueryRequest('structure-query-submit-form');">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div style="display: none;">
                <form id="no-params-service-submit">
                    <input type="text" name="itemId" hidden disabled>
                    <input type="text" name="path" hidden disabled>
                </form>
            </div>

            <div id="progress" class="popup" style="display: none; position: absolute;">

            </div>

        </body>
    </html>