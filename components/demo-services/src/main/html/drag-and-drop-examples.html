<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Workflow examples</title>

        <style>
            .glasspane {
                z-index: 999;
                width: 100%;
                height: 100%;
                top: 0;
                left: 0;
                display: none;
                position: absolute;				
                background: rgba(0,0,0,.5);
            }
            .popup {
                z-index: 1000;
                position: absolute;
                background-color: white;
                border-style: solid;
                border-color: darkgrey;
                border-width: 4px;
                /* To align popup window at the center of screen*/
                top: 50%;
                left: 50%;
            }

            #progress {
                z-index: 1000;
                position: absolute;
                background-color: white;
                border-style: solid;
                border-color: darkgrey;
                border-width: 4px;
                top: 0%;
                left: 0%;

            </style>

            <script type="text/javascript">
                function pop(div) {
                    document.getElementById(div).style.display = 'block';
                }
                function hide(div) {
                    document.getElementById(div).style.display = 'none';
                }
            </script>

            <style type="text/css">

                a:hover {
                    text-decoration: underline;
                }

                body {
                    margin:0;
                    padding:0;
                    background: whitesmoke;
                }

                #topsection {
                    height: 50px; /*Height of top section*/
                    background: black;
                    color: white;
                }

                #links {
                    padding-top: 5px;
                    float: right;
                }

                #topsection h1 {
                    margin: 0;
                    padding-top: 5px;
                }

                #helpcontent {
                    padding: 5px;
                }

                #help li {
                    font-size: small;
                }

                #contentwrapper {
                    float: left;
                    width: 100%;
                }

                #contentcolumn {
                    margin: 0 180px 0 80px; /*Margins for content column. Should be "0 RightColumnWidth 0 LeftColumnWidth*/
                    padding: 5px;
                }

                #leftcolumn {
                    float: left;
                    width: 70px; /*Width of left column*/
                    margin-left: -100%;
                    padding: 5px;
                }

                #workflowcolumn {
                    float: left;
                    width: 170px; /*Width of right column*/
                    margin-left: -180px; /*Set left marginto -(RightColumnWidth)*/
                    padding: 5px;
                }

                #leftcontent {
                    min-height: 500px;
                }

                #workflowcontent {
                    min-height: 500px;
                }

                #queries {
                    min-height: 100px;
                } 

                #files {
                    min-height: 100px;
                } 

                #services {
                    min-height: 100px;
                } 

                .boxed {
                    background-color: white;
                    border-style: solid;
                    border-color: grey;
                    border-width: 2px;
                    padding: 2px 2px 2px 2px;
                    overflow: auto;
                }

                #footer {
                    position: fixed;
                    bottom: 0px;
                    clear: left;
                    width: 100%;
                    background: black;
                    color: white;
                    text-align: center;
                    padding: 4px 0px;
                    font-size: small;
                }

                .innertube {
                    margin: 10px; /*Margins for inner DIV inside each column (to provide padding)*/
                    margin-top: 0;
                }

                div.component {
                    display: block;
                    margin: 2px 2px 2px 2px;
                    padding: 0px;
                    border-style: solid;
                    border-width: 2px;
                    border-radius: 6px;
                    font-size: smaller;
                    pointer-events: all; //TODO
                }

                div.info {
                    font-size: smaller;
                    text-align: right;
                    color: grey;
                }

                div.palette div.component {
                    float: left;
                }

                div.workflowcontent div {
                    display: block;
                    margin-top: 0px;
                    margin-bottom: 0px;
                    margin-left: auto;
                    margin-right: auto;
                    overflow: hidden;

                }

                div.query {
                    background-color: #ddffdd;
                    border-color: limegreen;
                    width: 100px;
                }

                div.query div.title {
                    background: limegreen;
                    color: white;
                }

                div.dataitem {
                    background-color: lavender;
                    border-color: cornflowerblue;
                    width: 100px;
                }

                div.dataitem div.title {
                    background: cornflowerblue;
                    color: white;
                }

                div.service {
                    background-color: linen;
                    border-color: orange;
                    width: 100px;
                }

                div.service div.title {
                    background: orange;
                    color: white;
                }

                div.action {
                    margin: 2px 2px 2px 2px;
                    padding: 0px;
                    background-color: whitesmoke;
                    border-color: black;
                    width: 50px;
                    //margin-left: auto;
                    //margin-right: auto;
                }

                div.action div.title {
                    background: black;
                    color: white;
                }

                div.component.over {
                    border-width: 4px;
                    border-style: dotted;
                    margin: 0px;
                }

                div.boxed.over {
                    border-width: 4px;
                    border-style: dashed;
                    padding: 0px;
                }

                .workflowarrow {
                    display: block;
                    margin-top: 0px;
                    margin-bottom: 0px;
                    margin-left: auto;
                    margin-right: auto;
                }

                div.title {
                    text-align: center;
                    white-space: nowrap; 
                    overflow: hidden;
                    text-overflow: ellipsis;
                    margin: 0px;
                    padding: 0px;
                    font-size: small;               
                }

                div.content {
                    margin: 1px;
                }

                .internal-element {
                    pointer-events: none;
                }

            </style>

        </head>
        <body>
            <div id="maincontainer">
                <div id="topsection"><div class="innertube">
                        <div id="links"><a onclick="pop('help')">Help</a></div>
                        <div><h1>Workflow examples</h1></div>
                    </div>
                </div>

                <div id="contentwrapper">
                    <div id="contentcolumn">
                        <div id="queriesBox" class="innertube boxed"><b>Data set generators</b>
                            <div id="queries" class="palette">
                            </div>
                        </div>
                        <div id="filesBox" class="innertube boxed"><b>Data sets</b>
                            <div id="files" class="palette internal-element" title="Drop files here to load">
                            </div>
                        </div>
                        <div id="servicesBox" class="innertube boxed"><b>Services</b> 
                            <div id="services" class="palette">
                            </div>
                        </div>

                    </div>

                </div>

                <div id="leftcolumn">
                    <div id="leftcontent" class="boxed">
                        <div><b>Actions</b> </div>
                        <div id="actions">
                        </div>
                    </div>
                </div>

                <div id="workflowcolumn">
                    <div id="workflow" class="boxed">
                        <div><b>Workflow</b></div>
                        <div id="workflowcontent" class="workflowcontent internal-element">
                        </div>
                    </div>
                </div>

                <div id="footer">This site is for illustration purposes only -
                    you are requested not to use it for real work. 
                    Data loaded to the site is visible to all.</div>
            </div>

            <script>

                function indexOf(array_values, value) {
                    for (var i = 0; i < array_values.length; i++) {
                        if (value === array_values[i]) {
                            return i;
                        }
                    }
                    return -1;
                }

                function createComponentDiv(item, icon, desc) {
                    var div = document.createElement("div");
                    div.id = item.id;
                    div.draggable = true;

                    var img = document.createElement("img");
                    img.src = icon;
                    img.draggable = false;
                    img.width = 48;
                    img.height = 48;
                    img.align = "left";
                    img.className = 'internal-element';

                    var title = document.createElement("div");
                    title.className = "title internal-element";
                    title.innerHTML = item.name;

                    var content = document.createElement("div");
                    content.className = "content internal-element";
                    var info = document.createElement("div");
                    info.className = "info internal-element";
                    if (desc !== undefined) {
                        info.innerHTML = desc;
                    }
                    content.appendChild(img);
                    content.appendChild(info);
                    div.appendChild(title);
                    div.appendChild(content);
                    return div;
                }

                function createActionDiv(item, icon) {
                    var div = document.createElement("div");
                    div.id = item.id;
                    div.draggable = false;

                    var img = document.createElement("img");
                    img.src = icon;
                    img.draggable = false;
                    img.width = 48;
                    img.height = 48;
                    img.className = 'internal-element';

                    var title = document.createElement("div");
                    title.className = "title internal-element";
                    title.innerHTML = item.name;
                    div.appendChild(title);
                    div.appendChild(img);
                    return div;
                }


                var filesDiv = document.getElementById("files");
                var filesBoxDiv = document.getElementById("filesBox");
                filesBoxDiv.addEventListener("dragenter", handleDataItemsBoxDragEnter, false);
                filesBoxDiv.addEventListener("dragleave", handleDragLeave, false);
                filesBoxDiv.addEventListener("dragover", preventDefaultEventHandling, false);
                filesBoxDiv.addEventListener("drop", handleDropOntoDataItems, false);

                function handleDataItemsBoxDragEnter(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    if (dataItemBoxCanHandleDrop(e)) {
                        this.classList.add('over');
                    }
                    return false;
                }

                function dataItemBoxCanHandleDrop(e) {
                    var dt = e.dataTransfer;
                    if (indexOf(dt.types, 'queryid') >= 0) {
                        return true;
                    } else if (indexOf(dt.types, 'Files') >= 0) {
                        return true;
                    }
                    return false;
                }

                var workflowDiv = document.getElementById("workflowcontent");
                var workflowBoxDiv = document.getElementById("workflow");

                workflowBoxDiv.addEventListener("dragenter", handleWorkflowBoxDragEnter, false);
                workflowBoxDiv.addEventListener("dragover", preventDefaultEventHandling, false);
                workflowBoxDiv.addEventListener("dragleave", handleDragLeave, false);
                workflowBoxDiv.addEventListener("drop", dropOntoWorkflow, false);

                function handleWorkflowBoxDragEnter(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    if (workflowBoxCanHandleDrop(e)) {
                        this.classList.add('over');
                    }
                    return false;
                }

                function workflowBoxCanHandleDrop(e) {
                    var dt = e.dataTransfer;
                    if (indexOf(dt.types, 'queryid') >= 0) {
                        return true;
                    } else if (indexOf(dt.types, 'dataitemid') >= 0) {
                        return true;
                    } else if (indexOf(dt.types, 'serviceid') >= 0) {
                        return true;
                    }
                    return false;
                }

                window.addEventListener("load", reLoadDataItems, false);
                window.addEventListener("dragover", preventDefaultEventHandling, false);
                window.addEventListener("drop", preventDefaultEventHandling, false);


                var queriesItems = [
                    //                    {id: "emols_sc",
                    //                        name: "eMols screening cpds",
                    //                        info: "6056409",
                    //                        popup: "structure-query-submit",
                    //                        form: "structure-query-submit-form",
                    //                        path: "/chemsearch",
                    //                        endpoint: "direct:chemsearch/emolecules_sc",
                    //    icon: "icons/databasemolecule.png"},
                    {id: "emols_bb",
                        name: "eMols building blocks",
                        info: "818887",
                        popup: "structure-query-submit",
                        form: "structure-query-submit-form",
                        path: "/chemsearch",
                        endpoint: "direct:chemsearch/emolecules_bb",
                        icon: "icons/databasemolecule.png"},
                    {id: "drugbank",
                        name: "DrugBank",
                        info: "3401",
                        popup: "structure-query-submit",
                        form: "structure-query-submit-form",
                        path: "/chemsearch",
                        endpoint: "direct:chemsearch/drugbank",
                        icon: "icons/databasemolecule.png"},
                    {id: "Reactor",
                        name: "1 step reactor",
                        description: "ChemAxon Reactor (1 step)",
                        popup: "reactor-service-submit",
                        form: "reactor-service-submit-form",
                        path: "/react",
                        icon: "icons/chemicalreaction.png"},
                    {id: "React and Screen",
                        name: "React and filter",
                        description: "ChemAxon Reactor followed by drug-like filter and property prediction",
                        popup: "reactor-service-submit",
                        form: "reactor-service-submit-form",
                        path: "/react_filter_predict",
                        icon: "icons/chemreaction_filtered.png"}
                ];

                var queriesDiv = document.getElementById("queries");
                for (var i = 0; i < queriesItems.length; i++) {
                    var query = queriesItems[i];

                    var div = createComponentDiv(query, findIcon(query, "icons/Misc-Database-3-icon.png"), query.info);
                    div.query = query;
                    div.className = "component query";

                    queriesDiv.appendChild(div);

                    div.addEventListener("dragenter", preventDefaultEventHandling, false);
                    div.addEventListener("dragleave", preventDefaultEventHandling, false);
                    div.addEventListener("dragover", preventDefaultEventHandling, false);
                    div.addEventListener('dragstart', function (e) {
                        e.dataTransfer.setData('queryid', e.target.id);
                        e.dataTransfer.setData('id', e.target.id);
                    }, false);
                }


                function reLoadDataItems() {
                    while (filesDiv.hasChildNodes()) {
                        filesDiv.removeChild(filesDiv.lastChild);
                    }

                    console.log("Requesting data items");
                    var xhr = new XMLHttpRequest();
                    xhr.open("GET", "/rest/files", true);
                    xhr.overrideMimeType('text/plain; charset=x-user-defined-binary');
                    xhr.onload = function (oEvent) {
                        console.log("xhr.onload()");
                        var status = xhr.status;
                        if (status === 200) {
                            var allData = JSON.parse(xhr.responseText);
                            console.log("received response");
                            addDataItems(allData);
                        }
                    };
                    xhr.send();
                }


                function addDataItems(dataItems) {
                    for (var i = 0; i < dataItems.length; i++) {
                        var item = dataItems[i];
                        addDataItem(item);
                    }
                }

                function addDataItem(item) {
                    console.log("Adding data item ID= " + item.id + " name=" + item.name);

                    var info = item.size;

                    var div = createComponentDiv(item, findIcon(item, "icons/moleculesmany.png"), info);
                    div.title = "[" + item.id + "] " + item.name;
                    div.item = item;
                    div.className = "component dataitem droptarget";

                    filesDiv.appendChild(div);
                    console.log("Item added");
                    div.addEventListener("dragenter", handleDataItemDragEnter, false);
                    div.addEventListener("dragleave", handleDragLeave, false);
                    div.addEventListener("dragover", dataItemCanHandleDrop, false);
                    div.addEventListener('dragstart', function (e) {
                        e.dataTransfer.setData('dataitemid', e.target.id);
                        e.dataTransfer.setData('id', e.target.id);
                    }, false);
                    div.addEventListener("drop", dropOntoDataItem, false);
                }

                function handleDragLeave(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    this.classList.remove('over');
                    return false;
                }

                function handleDataItemDragEnter(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    if (dataItemCanHandleDrop(e)) {
                        this.classList.add('over');
                    }
                    return false;
                }

                function dataItemCanHandleDrop(e) {
                    var dt = e.dataTransfer;
                    if (indexOf(dt.types, 'serviceid') >= 0) {
                        return true;
                    }
                    return false;
                }

                var servicesItems = [
                    {id: "calcLogP",
                        name: "LogP Calculators",
                        description: "LogP calculations from\nChemAxon and CDK",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:logp",
                        icon: "icons/propertiesadd.png"},
                    {id: "calcLipinski",
                        name: "Lipinski props",
                        description: "Lipinski Rule of Five properties",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:lipinski",
                        icon: "icons/propertiesadd.png"},
                    {id: "drugLikeFilter",
                        name: "Drug like filter",
                        description: "mw < 400\nrings >0\nrotatable bonds <5\ndonors<=5\nacceptors<=10\nlogp<4",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:filter_example",
                        icon: "icons/propertiesfilter.png"},
                    {id: "ecfpScreen",
                        name: "ECFP4 screen",
                        description: "Screen using ECFP4 fingerprints",
                        popup: "screening-service-submit",
                        form: "screening-service-submit-form",
                        path: "/process",
                        endpoint: "direct:screening/ecfp",
                        icon: "icons/propertiesfilter.png"},
                    {id: "pharmacophoreScreen",
                        name: "Pharmacophore screen",
                        description: "Screen using 2D pharmacophore fingerprints",
                        popup: "screening-service-submit",
                        form: "screening-service-submit-form",
                        path: "/process",
                        endpoint: "direct:screening/pharmacophore",
                        icon: "icons/propertiesfilter.png"},
                    {id: "spherexClust",
                        name: "Spherex Clustering",
                        description: "1-level clustering using\nadaptive sphere exclusion clustering",
                        popup: "spherex-clustering-service-submit",
                        form: "spherex-clustering-service-submit-form",
                        path: "/process",
                        endpoint: "direct:clustering/spherex/ecfp4",
                        icon: "icons/clustering.png"},
                    {id: "RDKitPredict",
                        name: "RDKit prop predict",
                        description: "Property prediction using RDKit",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:rdkit/predict",
                        icon: "icons/propertiesadd.png"},
                    {id: "RDKitFilter",
                        name: "RDKit filter",
                        description: "Molecule filtering using RDKit",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:rdkit/filter",
                        icon: "icons/propertiesfilter.png"},
                    {id: "RDKitServerCluster",
                        name: "RDKit cluster",
                        description: "Molecule clustering using RDKit",
                        popup: "rdkit-screen-service-submit",
                        form: "rdkit-screen-service-submit-form",
                        path: "/process",
                        endpoint: "direct:rdkitserver/cluster",
                        icon: "icons/clustering.png"},
                    {id: "RDKitServerScreen",
                        name: "RDKit screen",
                        description: "Virtual screening using RDKit",
                        popup: "rdkit-screen-service-submit",
                        form: "rdkit-screen-service-submit-form",
                        path: "/process",
                        endpoint: "direct:rdkitserver/screen",
                        icon: "icons/propertiesfilter.png"},
                    {id: "removeFragmentsKeepLargest",
                        name: "Remove fragments",
                        description: "Remove fragments (keep largest)",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:removeFragmentsKeepLargest",
                        icon: "icons/transform.png"},
                    {id: "removesolvents",
                        name: "Remove solvents",
                        description: "Remove solvents",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:removesolvents",
                        icon: "icons/transform.png"},
                    {id: "aromatizeGeneral",
                        name: "Aromatize (general)",
                        description: "Aromatize (Daylight style)",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:aromatizeGeneral",
                        icon: "icons/transform.png"},
                    {id: "aromatizeBasic",
                        name: "Aromatize (ChemAxon style)",
                        description: "Aromatize (basic)",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:aromatizeBasic",
                        icon: "icons/transform.png"},
                    {id: "aromatizeLoose",
                        name: "aromatize (loose)",
                        description: "aromatize (loose)",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:aromatizeLoose",
                        icon: "icons/transform.png"},
                    {id: "dearomatize",
                        name: "De-aromatize",
                        description: "De-aromatize",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:dearomatize",
                        icon: "icons/transform.png"},
                    {id: "neutralize",
                        name: "Neutralize",
                        description: "Neutralize charged molecules by adjusting hydrogens",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:neutralize",
                        icon: "icons/transform.png"},
                    {id: "addexplicith",
                        name: "Add explicit H",
                        description: "Add explicit hydrogens",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:addexplicith",
                        icon: "icons/transform.png"},
                    {id: "removeexplicith",
                        name: "Remove explicit H",
                        description: "Remove explicit hydrogens",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:removeexplicith",
                        icon: "icons/transform.png"},
                    {id: "expandsgroups",
                        name: "Expand S-groups",
                        description: "Expand S-groups",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:expandsgroups",
                        icon: "icons/transform.png"},
                    {id: "contractsgroups",
                        name: "Contract S-groups",
                        description: "Contract S-groups",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:contractsgroups",
                        icon: "icons/transform.png"},
                    {id: "ungroupsgroups",
                        name: "Ungroup S-groups",
                        description: "Ungroup S-groups",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:ungroupsgroups",
                        icon: "icons/transform.png"},
                    {id: "tautomerize",
                        name: "Tautomerize",
                        description: "Generate a cannonical tautomer",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:tautomerize",
                        icon: "icons/transform.png"},
                    {id: "mesomerize",
                        name: "Mesomerize",
                        description: "Generate a cannonical resonant structure",
                        popup: "basic-params-service-submit",
                        form: "basic-service-submit-form",
                        path: "/process",
                        endpoint: "direct:mesomerize",
                        icon: "icons/transform.png"}

                ];

                var servicesDiv = document.getElementById("services");
                for (var i = 0; i < servicesItems.length; i++) {
                    var service = servicesItems[i];

                    var div = createComponentDiv(service, findIcon(service, "icons/Very-Basic-Services-icon.png"));
                    div.service = service;
                    div.className = "component service droptarget";
                    div.title = service.description;

                    servicesDiv.appendChild(div);

                    div.addEventListener("dragenter", handleServiceDragEnter, false);
                    div.addEventListener("dragleave", handleDragLeave, false);
                    div.addEventListener("dragover", serviceCanHandleDrop, false);
                    div.addEventListener("drop", dropOntoService, false);
                    div.addEventListener('dragstart', function (e) {
                        console.log("Dragging " + e.target.id)
                        e.dataTransfer.setData('serviceid', e.target.id);
                        e.dataTransfer.setData('id', e.target.id);
                    }, false);
                }

                function handleServiceDragEnter(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    if (serviceCanHandleDrop(e)) {
                        this.classList.add('over');
                    }
                    return false;
                }

                function serviceCanHandleDrop(e) {
                    var dt = e.dataTransfer;
                    if (indexOf(dt.types, 'dataitemid') >= 0) {
                        return true;
                    }
                    return false;
                }


                var otherActionItems = [
                    {id: "delete",
                        name: "Delete",
                        handler: handleFileDelete,
                        icon: "icons/bin.png"},
                    {id: "export",
                        name: "Export",
                        path: "/files/download",
                        handler: handleFileDownload,
                        icon: "icons/export.png"},
                    {id: "view",
                        name: "View",
                        icon: "icons/view.png"}
                ];

                var actionsDiv = document.getElementById("actions");
                for (var i = 0; i < otherActionItems.length; i++) {
                    var service = otherActionItems[i];

                    var div = createActionDiv(service, findIcon(service, "icons/Very-Basic-Services-icon.png"));
                    div.service = service;
                    div.className = "component action droptarget";
                    div.draggable = false;

                    actionsDiv.appendChild(div);
                    div.addEventListener("dragenter", handleServiceDragEnter, false);
                    div.addEventListener("dragleave", handleDragLeave, false);
                    div.addEventListener("dragover", handleActionDragOver, false);
                    var dropHandler = service.handler;
                    if (dropHandler === undefined) {
                        dropHandler = dropOntoService;
                    }
                    div.addEventListener("drop", dropHandler, false);
                }

                function handleActionDragEnter(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    if (serviceCanHandleDrop(e)) {
                        this.classList.add('over');
                    }
                    return false;
                }

                function handleActionDragOver(e) {
                    if (actionCanHandleDrop(e)) {
                        preventDefaultEventHandling(e);
                        return false;
                    }
                    return true;
                }

                function actionCanHandleDrop(e) {
                    var dt = e.dataTransfer;
                    if (indexOf(dt.types, 'dataitemid') >= 0) {
                        return true;
                    }
                    return false;
                }

                function findIcon(obj, defaultIcon) {
                    var src = obj.icon;
                    if (src === undefined) {
                        return defaultIcon;
                    } else {
                        return src;
                    }
                }

                function preventDefaultEventHandling(e) {
                    e.stopPropagation();
                    e.preventDefault();
                }



                function dropOntoWorkflow(e) {
                    console.log("Item dropped onto workflow");
                    e.stopPropagation();
                    e.preventDefault();
                    this.classList.remove('over');
                    var dt = e.dataTransfer;
                    var serviceID = dt.getData('serviceid');
                    var dataItemID = dt.getData('dataitemid');
                    var queryID = dt.getData('queryid');
                    if (serviceID.length > 0) {
                        console.log("Handling service " + serviceID);
                        handleWorkflowDropService(serviceID);
                    } else if (dataItemID.length > 0) {
                        console.log("handling data item " + dataItemID);
                        handleWorkflowDataItem(dataItemID);
                    } else if (queryID.length > 0) {
                        console.log("handling query ") + queryID;
                        handleWorkflowQuery(queryID);
                    }
                }

                function handleWorkflowQuery(queryID) {
                    console.log("Handling workflow query " + queryID);
                    var queryDiv = document.getElementById(queryID);
                    var query = queryDiv.query;

                    var div = createComponentDiv(query, findIcon(query, "icons/Misc-Database-3-icon.png"), query.info);
                    div.query = query;
                    div.className = "component query";
                    div.draggable = false; // this need to change to allow rearrangement                    

                    workflowDiv.appendChild(div);
                }

                function handleWorkflowDataItem(dataItemID) {
                    console.log("Handling workflow data item " + dataItemID);
                    var dataItemDiv = document.getElementById(dataItemID);
                    var dataItem = dataItemDiv.item;

                    var div = createComponentDiv(dataItem, findIcon(dataItem, "icons/Chemical-5-icon.png"), dataItem.size);
                    div.item = dataItem;
                    div.className = "component dataitem";
                    div.draggable = false; // this need to change to allow rearrangement                    

                    workflowDiv.appendChild(div);
                }

                function handleWorkflowDropService(serviceID) {
                    console.log("Handling workflow service " + serviceID);
                    var serviceDiv = document.getElementById(serviceID);
                    var arrow = document.createElement("img");
                    arrow.src = "icons/Down-Arrow-icon.png";
                    arrow.draggable = false;
                    arrow.width = 32;
                    arrow.height = 32;
                    arrow.align = "middle";
                    arrow.className = "workflowarrow";
                    var arrowDiv = document.createElement("div");
                    arrowDiv.appendChild(arrow);
                    workflowDiv.appendChild(arrowDiv);

                    var service = serviceDiv.service;
                    var div = createComponentDiv(service, findIcon(service, "icons/Very-Basic-Services-icon.png"));
                    div.service = service;
                    div.className = "component service ";
                    div.draggable = false; // this need to change to allow rearrangement

                    workflowDiv.appendChild(div);
                }

                function dropOntoDataItem(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    this.classList.remove('over');

                    if (!dataItemCanHandleDrop(e)) {
                        return;
                    }

                    var dataItemDiv = findDropDiv(e.target, "droptarget");
                    if (dataItemDiv === undefined) {
                        console.log("Data item not found");
                        return;
                    }
                    var dt = e.dataTransfer;
                    var serviceId = dt.getData('serviceid');
                    var serviceDiv = document.getElementById(serviceId);
                    if (serviceDiv === undefined) {
                        console.log("Service not found");
                        return;
                    }
                    console.log("Dropped " + serviceDiv.id + " onto " + dataItemDiv.id);
                    console.log("Data item is " + dataItemDiv.item);
                    console.log("Service is " + serviceDiv.service);
                    handleDataItemServiceDrop(dataItemDiv.item, serviceDiv.service);
                    return false;
                }

                /*
                 * This needs handling better.
                 */
                function handleFileDownload(e) {
                    console.log("Handling file download");
                    e.stopPropagation();
                    e.preventDefault();
                    this.classList.remove('over');

                    var dt = e.dataTransfer;
                    var dataId = dt.getData('dataitemid');
                    if (dataId === undefined) {
                        console.log("No DataItem defined");
                        return;
                    }
                    window.open("/rest/files/" + dataId);
                    return false;
                }


                function handleFileDelete(e) {
                    console.log("Handling file delete");
                    e.stopPropagation();
                    e.preventDefault();
                    this.classList.remove('over');

                    var dt = e.dataTransfer;
                    var dataId = dt.getData('dataitemid');
                    if (dataId === undefined) {
                        console.log("No DataItem defined");
                        return;
                    }
                    var xhr = new XMLHttpRequest();
                    xhr.open("DELETE", "/rest/files/" + dataId, true);
                    xhr.onload = function () {
                        hide("progress");
                        var status = xhr.status;
                        if (status === 200) {
                            console.log("Processing OK");
                            var div = document.getElementById(dataId);
                            div.parentNode.removeChild(div);
                        } else {
                            alert("Delete failed");
                        }
                    };
                    xhr.send();
                    return false;
                }

                function dropOntoService(e) {
                    console.log("Drop event: " + e + " Drop onto " + this.id + " Dropped item: " + e.dataTransfer.getData("id"));
                    e.stopPropagation();
                    e.preventDefault();
                    this.classList.remove('over');
                    if (!serviceCanHandleDrop(e)) {
                        return;
                    }
                    var serviceDiv = findDropDiv(e.target, "droptarget");
                    var dt = e.dataTransfer;
                    var dataId = dt.getData('dataitemid');
                    var itemDiv = document.getElementById(dataId);
                    handleDataItemServiceDrop(itemDiv.item, serviceDiv.service);
                    return false;
                }

                function handleDataItemServiceDrop(dataItem, service) {
                    console.log("Running service " + service.id + " for data " + dataItem.name);
                    var path = service.path;
                    if (path === undefined) {
                        alert("Service not yet implemented");
                        return;
                    }
                    var formName = service.form;
                    if (formName === undefined) {
                        var noParamsForm = document.getElementById("no-params-service-submit");
                        populateServiceRequestForm(noParamsForm, dataItem, service);
                        handleServiceRequest("no-params-service-submit");
                    } else {
                        var form = document.getElementById(service.form);
                        populateServiceRequestForm(form, dataItem, service);
                        console.log("Showing popup");
                        pop(service.popup);
                    }
                }

                function handleServiceRequest(formId) {
                    var form = document.getElementById(formId);
                    console.log("Form ID is " + formId + ", form is " + form);
                    var formData = new FormData();
                    var path;
                    for (var i = 0; i < form.elements.length; i++) {
                        var el = form.elements[i];
                        console.log("Handling element " + el.name);
                        if (el.name === "inputName") {
                            // do nothing
                        } else if (el.name === "itemId") {
                            formData.append("item", el.value);
                            console.log("Item ID set to " + el.value);
                        } else if (el.name === "serviceEndpoint") {
                            formData.append("endpoint", el.value);
                            console.log("Endpoint set to " + el.value);
                        } else if (el.name === "outputName") {
                            formData.append("itemName", el.value);
                            console.log("New name set to " + el.value);
                        } else if (el.name === "path") {
                            path = el.value;
                            console.log("Path set to " + el.value);
                        } else if (el.name !== undefined) {
                            formData.append(el.name, el.value);
                            console.log(el.name + " set to " + el.value);
                        }

                    }
                    if (path === undefined) {
                        return;
                    }

                    var prog = createProgress("Processing");
                    pop("progress");

                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", path, true);
                    xhr.onload = function () {
                        handlePostForDataItems(xhr);
                    };
                    console.log("Posting request to " + path);
                    xhr.send(formData);
                }

                function handlePostForDataItems(xhr) {
                    hide("progress");
                    var status = xhr.status;
                    if (status === 200) {
                        console.log("Processing OK");
                        var json = xhr.response;
                        console.log("JSON: " + json);
                        if (json === undefined || json.length === 0) {
                            // no response so nothing to do
                        } else {
                            console.log("Response JSON: " + json);
                            var items = JSON.parse(json);
                            if (items.length > 0) {
                                console.log("Adding items");
                                addDataItems(items);
                            } else {
                                alert("No results!");
                            }
                        }
                    } else {
                        alert("Processing failed");
                    }
                }

                function createProgress(name, max) {
                    var div = document.getElementById("progress");
                    while (div.hasChildNodes()) {
                        div.removeChild(div.lastChild);
                    }
                    var span = document.createElement("span");
                    span.innerHTML = name + ":&nbsp;";
                    div.appendChild(span);
                    var prog = document.createElement("progress");
                    div.appendChild(prog);
                    if (max !== undefined) {
                        prog.max = max;
                        prog.value = 0;
                    }
                    return prog;
                }

                function handleDropOntoDataItems(e) {

                    e.stopPropagation();
                    e.preventDefault();
                    this.classList.remove('over');
                    if (e.dataTransfer.files !== undefined && e.dataTransfer.files.length > 0) {
                        console.log("File dropped");
                        handleDropFiles(e);
                    } else if (e.dataTransfer.getData('queryid') !== undefined) {
                        console.log("Query dropped");
                        handleDropQueryOntoDataItems(e);
                    } else {
                        console.log("Unrecognised drop");
                    }
                }

                function handleDropQueryOntoDataItems(e) {
                    var dt = e.dataTransfer;
                    var queryId = dt.getData('queryid');
                    if (queryId.length === 0) {
                        return;
                    }
                    var queryDiv = document.getElementById(queryId);
                    var query = queryDiv.query;
                    var form = document.getElementById(query.form);
                    setFormProperty(form, "queryName", query.name);
                    setFormProperty(form, "queryId", query.id);
                    setFormProperty(form, "outputName", "");
                    if (form.id === "reactor-service-submit-form") {
                        setFormProperty(form, "path", query.path);
                        setFormProperty(form, "serviceName", query.name);
                        populateReactantsCombo(form["Reactants1"]);
                        populateReactantsCombo(form["Reactants2"]);
                    }
                    pop(query.popup);

                }

                function handleQueryRequest(formId) {
                    var form = document.getElementById(formId);
                    console.log("Form ID " + formId + " is " + form);
                    var formData = new FormData();

                    //serviceEndpoint path queryStructure searchOptions outputName
                    var els = form.elements;
                    var queryId = els['queryId'].value;
                    var query = document.getElementById(queryId).query;

                    var path = query.path;
                    formData.append("endpoint", query.endpoint);
                    formData.append("QueryStructure", els['queryStructure'].value);
                    formData.append("JChemSearchOptions", els['searchOptions'].value);
                    formData.append("itemName", els['outputName'].value);

                    createProgress("Processing");
                    pop("progress");

                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", path, true);
                    xhr.onload = function () {
                        hide("progress");
                        handlePostForDataItems(xhr);
                    };
                    console.log("Posting request to " + path);
                    xhr.send(formData);

                }

                function handleDropFiles(e) {

                    var files = e.dataTransfer.files; // Array of all files
                    for (var i = 0; i < files.length; i++) {
                        var prog = createProgress("File upload", 100);
                        pop("progress");
                        var file = files[i];
                        var name = file.name;
                        console.log("Dropped file 1 " + name + " - " + file);
                        var formData = new FormData();
                        formData.append('file', file, file.name);
                        var xhr = new XMLHttpRequest();
                        xhr.open("POST", "/files/upload", true);
                        xhr.onload = function () {
                            hide("progress");
                            var status = xhr.status;
                            if (status === 200) {
                                var json = xhr.response;
                                var results = JSON.parse(json);
                                addDataItems(results);
                            } else {
                                alert("File load failed");
                            }
                        };
                        xhr.upload.addEventListener("progress", function (e) {
                            if (e.lengthComputable) {
                                var percentage = Math.round((e.loaded * 100) / e.total);
                                console.log("Progress: " + e + " | " + percentage);
                                prog.value = percentage;
                            }
                        }, false);
                        xhr.upload.addEventListener("load", function (e) {
                            prog.value = 100;
                            prog = createProgress("Processing");
                        }, false);
                        xhr.upload.addEventListener("error", function (e) {
                            hide("progress");
                            altert("Error encountered uploading file");
                        }, false);
                        xhr.send(formData);
                    }
                    return false;
                }

                function handleReactorRequest(formId) {
                    var form = document.getElementById(formId);
                    console.log("Form ID is " + formId + ", form is " + form);
                    var formData = new FormData();
                    var path;
                    for (var i = 0; i < form.elements.length; i++) {
                        var el = form.elements[i];
                        console.log("Handling element " + el.name);
                        if (el.name === "path") {
                            path = el.value;
                            console.log("Path set to " + el.value);
                        } else if (el.name !== undefined) {
                            formData.append(el.name, el.value);
                            console.log(el.name + " set to " + el.value);
                        }
                    }
                    var prog = createProgress("Processing");
                    pop("progress");

                    var xhr = new XMLHttpRequest();
                    xhr.open("POST", path, true);
                    xhr.onload = function () {
                        handlePostForDataItems(xhr);
                    };
                    console.log("Posting request to " + path);
                    xhr.send(formData);
                }

                function findDropDiv(target, cls) {
                    if (target === undefined) {
                        return null;
                    } else if (target.classList.contains(cls)) {
                        return target;
                    } else if (target.parentNode === undefined) {
                        return null;
                    } else {
                        return findDropDiv(target.parentNode, cls);
                    }
                }

                function populateServiceRequestForm(form, item, service) {
                    form.reset();
                    setFormProperty(form, "path", service.path);
                    setFormProperty(form, "serviceEndpoint", service.endpoint);
                    setFormProperty(form, "serviceName", service.id);
                    setFormProperty(form, "inputName", item.name);
                    setFormProperty(form, "itemId", item.id);
                    setFormProperty(form, "outputName", "");
                }

                function populateReactantsCombo(combo) {
                    while (combo.length > 0) {
                        combo.remove(combo.length - 1);
                    }
                    var url = document.URL;
                    var div = document.getElementById("files");
                    for (var i = 0; i < div.children.length; i++) {
                        var child = div.children[i];
                        var item = child.item;
                        var option = document.createElement("option");
                        option.text = item.name;

                        var link = absolutize(url, "/rest/files/" + item.id);
                        console.log("URL: " + link)
                        option.value = link;
                        combo.add(option);
                    }
                }

                // may be a better way to do this
                function absolutize(base, url) {
                    d = document.implementation.createHTMLDocument();
                    b = d.createElement('base');
                    d.head.appendChild(b);
                    a = d.createElement('a');
                    d.body.appendChild(a);
                    b.href = base;
                    a.href = url;
                    return a.href;
                }

                function setFormProperty(form, propName, value) {
                    if (form[propName] !== undefined) {
                        form[propName].value = value;
                    }
                }
            </script>

            <div id="basic-params-service-submit" class="glasspane">
                <div class="popup" style="width: 400px; height: 200px; margin-top: -100px; margin-left: -200px;">
                    <div style="text-align: right;">
                        <a href="#" onClick="hide('basic-params-service-submit')">X</a>
                    </div>
                    <div>
                        <form id="basic-service-submit-form">
                            <input type="text" name="itemId" hidden disabled>
                            <input type="text" name="serviceEndpoint" hidden disabled>
                            <input type="text" name="path" hidden disabled>
                            <div>
                                <table cellpadding="3">
                                    <tr><td>Service:</td><td><input type="text" name="serviceName" size="20" disabled value=""></td></tr>
                                    <tr><td>Name of input:</td><td><input type="text" name="inputName" size="20" disabled value=""></td></tr>
                                    <tr><td>Name of output:</td><td><input type="text" name="outputName" size="20" value="" autofocus></td></tr>
                                </table>
                            </div>
                            <div style="position:absolute; right: 10px; bottom: 10px;">
                                <button type="button" onclick="hide('basic-params-service-submit');
                                        handleServiceRequest('basic-service-submit-form')">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="spherex-clustering-service-submit" class="glasspane">
                <div class="popup" style="width: 500px; height: 240px; margin-top: -120px; margin-left: -250px;">
                    <div style="text-align: right;">
                        <a href="#" onClick="hide('spherex-clustering-service-submit')">X</a>
                    </div>
                    <div>
                        <form id="spherex-clustering-service-submit-form">
                            <input type="text" name="itemId" hidden disabled>
                            <input type="text" name="serviceEndpoint" hidden disabled>
                            <input type="text" name="path" hidden disabled>
                            <div>
                                <table cellpadding="3">
                                    <tr><td>Service:</td><td><input type="text" name="serviceName" size="30" disabled value=""></td></tr>
                                    <tr><td>Name of input:</td><td><input type="text" name="inputName" size="30" disabled value=""></td></tr>
                                    <tr><td>Name of output:</td><td><input type="text" name="outputName" size="30" value="" autofocus></td></tr>
                                    <tr><td>Min clusters:</td><td><input type="text" name="MinClusterCount" size="5" value="5"></td></tr>
                                    <tr><td>Max clusters:</td><td><input type="text" name="MaxClusterCount" size="5" value="10"></td></tr>
                                </table>
                            </div>
                            <div style="position:absolute; right: 10px; bottom: 10px;">
                                <button type="button" onclick="hide('spherex-clustering-service-submit');
                                        handleServiceRequest('spherex-clustering-service-submit-form');">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="screening-service-submit" class="glasspane">
                <div class="popup" style="width: 500px; height: 240px; margin-top: -120px; margin-left: -250px;">
                    <div style="text-align: right;">
                        <a href="#" onClick="hide('screening-service-submit')">X</a>
                    </div>
                    <div>
                        <form id="screening-service-submit-form">
                            <input type="text" name="itemId" hidden disabled>
                            <input type="text" name="serviceEndpoint" hidden disabled>
                            <input type="text" name="path" hidden disabled>
                            <div>
                                <table cellpadding="3">
                                    <tr><td>Service:</td><td><input type="text" name="serviceName" size="30" disabled value=""></td></tr>
                                    <tr><td>Name of input:</td><td><input type="text" name="inputName" size="30" disabled value=""></td></tr>
                                    <tr><td>Name of output:</td><td><input type="text" name="outputName" size="30" value="" autofocus></td></tr>
                                    <tr><td>Query structure:</td><td><input type="text" name="QueryMolecule" size="30" value="NC1=CC=CC(NC2=NC=CC=N2)=C1"></td></tr>
                                    <tr><td>Threshold:</td><td><input type="text" name="Threshold" size="5" value="0.8"></td></tr>
                                </table>
                            </div>
                            <div style="position:absolute; right: 10px; bottom: 10px;">
                                <button type="button" onclick="hide('screening-service-submit');
                                        handleServiceRequest('screening-service-submit-form');">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="rdkit-screen-service-submit" class="glasspane">
                <div class="popup" style="width: 500px; height: 280px; margin-top: -140px; margin-left: -250px;">
                    <div style="text-align: right;">
                        <a href="#" onClick="hide('rdkit-screen-service-submit')">X</a>
                    </div>
                    <div>
                        <form id="rdkit-screen-service-submit-form">
                            <input type="text" name="itemId" hidden disabled>
                            <input type="text" name="serviceEndpoint" hidden disabled>
                            <input type="text" name="path" hidden disabled>
                            <div>
                                <table cellpadding="3">
                                    <tr><td>Service:</td><td><input type="text" name="serviceName" size="30" disabled value=""></td></tr>
                                    <tr><td>Name of input:</td><td><input type="text" name="inputName" size="30" disabled value=""></td></tr>
                                    <tr><td>Name of output:</td><td><input type="text" name="outputName" size="30" value="" autofocus></td></tr>
                                    <tr><td>Descriptor:</td><td>
                                            <select name="fp_method">
                                                <option value="atom_pairs">Atom pairs</option>
                                                <option value="maccs">MACCS keys</option>
                                                <option value="morgan" selected>Morgan fingerprints</option>
                                                <option value="rdkit_topo">RDKit topological fp</option>
                                            </select></td></tr>
                                    <tr><td>Metric:</td><td>
                                            <select name="sim_method">
                                                <option value="cosine">Cosine</option>
                                                <option value="dice">Dice</option>
                                                <option value="tanimoto" selected>Tanimoto</option>
                                                <option value="tversky">Tversky</option>

                                            </select></td></tr>
                                    <tr><td>Query structure:</td><td><input type="text" name="smiles" size="30" value="NC1=CC=CC(NC2=NC=CC=N2)=C1"></td></tr>
                                    <tr><td>Threshold:</td><td><input type="text" name="threshold" size="5" value="0.8"></td></tr>
                                </table>
                            </div>
                            <div style="position:absolute; right: 10px; bottom: 10px;">
                                <button type="button" onclick="hide('rdkit-screen-service-submit');
                                        handleServiceRequest('rdkit-screen-service-submit-form');">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div id="rdkit-cluster-service-submit" class="glasspane">
                <div class="popup" style="width: 500px; height: 280px; margin-top: -140px; margin-left: -250px;">
                    <div style="text-align: right;">
                        <a href="#" onClick="hide('rdkit-cluster-service-submit')">X</a>
                    </div>
                    <div>
                        <form id="rdkit-cluster-service-submit-form">
                            <input type="text" name="itemId" hidden disabled>
                            <input type="text" name="serviceEndpoint" hidden disabled>
                            <input type="text" name="path" hidden disabled>
                            <div>
                                <table cellpadding="3">
                                    <tr><td>Service:</td><td><input type="text" name="serviceName" size="30" disabled value=""></td></tr>
                                    <tr><td>Name of input:</td><td><input type="text" name="inputName" size="30" disabled value=""></td></tr>
                                    <tr><td>Name of output:</td><td><input type="text" name="outputName" size="30" value="" autofocus></td></tr>
                                    <tr><td>Descriptor:</td><td>
                                            <select name="fp_method">
                                                <option value="atom_pairs">Atom pairs</option>
                                                <option value="maccs">MACCS keys</option>
                                                <option value="morgan" selected>Morgan fingerprints</option>
                                                <option value="rdkit_topo">RDKit topological fp</option>
                                            </select></td></tr>
                                    <tr><td>Metric:</td><td>
                                            <select name="sim_method">
                                                <option value="cosine">Cosine</option>
                                                <option value="dice">Dice</option>
                                                <option value="tanimoto" selected>Tanimoto</option>
                                                <option value="tversky">Tversky</option>
                                            </select></td></tr>
                                    <tr><td>Threshold:</td><td><input type="text" name="threshold" size="5" value="0.8"></td></tr>
                                </table>
                            </div>
                            <div style="position:absolute; right: 10px; bottom: 10px;">
                                <button type="button" onclick="hide('rdkit-cluster-service-submit');
                                        handleServiceRequest('rdkit-cluster-service-submit-form');">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="reactor-service-submit" class="glasspane">
                <div class="popup" style="width: 500px; height: 240px; margin-top: -120px; margin-left: -250px;">
                    <div style="text-align: right;">
                        <a href="#" onClick="hide('reactor-service-submit')">X</a>
                    </div>
                    <div>
                        <form id="reactor-service-submit-form">
                            <input type="text" name="path" hidden disabled>
                            <div>
                                <table cellpadding="3">
                                    <tr><td>Service:</td><td><input type="text" name="serviceName" size="30" disabled value=""></td></tr>
                                    <tr><td>Reaction:</td><td><select name="Reaction">
                                                <option value="http://localhost:8080/reactions/amine-acylation.mrv">Amine +  acyl -> amide</option>
                                                <option value="http://localhost:8080/reactions/pyrimidine-formation-diketone-guanidine.mrv">1,3-diketone + guanidine -> pyrimidine</option>
                                                <option value="http://localhost:8080/reactions/alkylation-of-amines.mrv">Amine + alkyl halide -> N-alkyl</option>
                                            </select></td></tr>

                                    <tr><td>Reactants1:</td><td><select name="Reactants1"></select></td></tr>
                                    <tr><td>Reactants2:</td><td><select name="Reactants2"></select></td></tr>
                                    <tr><td>Name of output:</td><td><input type="text" name="itemName" size="30" value="" autofocus></td></tr>
                                </table>
                            </div>
                            <div style="position:absolute; right: 10px; bottom: 10px;">
                                <button type="button" onclick="hide('reactor-service-submit');
                                        handleReactorRequest('reactor-service-submit-form');">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div id="structure-query-submit" class="glasspane">
                <div class="popup" style="width: 500px; height: 200px; margin-top: -100px; margin-left: -250px;">
                    <div style="text-align: right;">
                        <a href="#" onClick="hide('structure-query-submit')">X</a>
                    </div>
                    <div>
                        <form id="structure-query-submit-form">
                            <input type="text" name="queryId" hidden disabled>
                            <div>
                                <table cellpadding="3">
                                    <tr><td>Database:</td><td><input type="text" name="queryName" size="30" disabled value=""></td></tr>
                                    <tr><td>Query structure:</td><td><input type="text" name="queryStructure" size="30" value="NC1=CC=CC(NC2=NC=CC=N2)=C1"></td>     
                                    <tr><td>Search type:</td><td>
                                            <select name="searchOptions">
                                                <option value="t:s">Substructure</option>
                                                <option value="t:i dissimilarityThreshold:0.1">90% Similarity</option>
                                                <option value="t:i dissimilarityThreshold:0.2">80% Similarity</option>
                                                <option value="t:i dissimilarityThreshold:0.3">70% Similarity</option>
                                            </select></td></tr>
                                    <tr><td>Name of output:</td><td><input type="text" name="outputName" size="20" value="" autofocus></td></tr>
                                </table>
                            </div>
                            <div style="position:absolute; right: 10px; bottom: 10px;">
                                <button type="button" onclick="hide('structure-query-submit');
                                        handleQueryRequest('structure-query-submit-form');">Submit</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div style="display: none;">
                <form id="no-params-service-submit">
                    <input type="text" name="itemId" hidden disabled>
                    <input type="text" name="path" hidden disabled>
                </form>
            </div>

            <div id="progress" class="popup" style="display: none; position: absolute;">
            </div>

            <div id="help" class="glasspane">
                <div class="popup" style="width: 500px; height: 300px; margin-top: -150px; margin-left: -250px;">
                    <div style="text-align: right;">
                        <a onClick="hide('help')">X</a>
                    </div>
                    <div id="helpcontent">
                        <p><b>Usage guide</b></p>
                        <ol>
                            <li>Drag a file (SD or smiles) onto Data sets to create a new dataset with the contents of that file 
                                (please limit yourself to relatively small files).</li>
                            <li>Drop Query onto Data sets to create a new dataset based on a query of the database</li>
                            <li>Drop a data set onto a service to send the data to the service and create 
                                a new data set with the results. Drop a service onto a data set does the same.</li>
                            <li>Drop a data set onto an action on the left hand side to perform the action on 
                                the data set (View is not yet implemented)</li>
                            <li>Drop query, data set or service onto the workflow area to build a workflow 
                                (workflows cannot yet be executed)</li>
                        </ol>
                    </div>
                </div>
            </div>

        </body>
    </html>