# You must set various environment variables before running anything.
# The easiest way is to create a shell script containing the definitions and 'source' it.
# A template file is present called docker/deploy/setenv-default.sh
# Copy this to docker/deploy/setenv.sh and edit it accordingly.
# Then 'source' it: source setenv.sh
# DO NOT edit setenv-default.sh directly with confidential information like passwords as it's stored in Git.
# Intead copy it to setenv.sh, which is .gitignore'd.
#
# To build the docker images move to the directory above this and run:
# ./build-internal.sh     <--- builds the containers containing our code
# ./build-external.sh     <--- builds the postgres and rabbitmq containers (should only need doing once, or when something changes in these)
#
# Once running you can set up the RabbitMQ users by running:
# docker exec deploy_mq_1 bash init.sh
# (or use some other input)

################# Rabbit MQ container #############################################
# admin console available on http://${DOCKER_GATEWAY}:15672/
#
mq:
    image: squonk/rabbitmq
    ports:
    - "5672:5672"
    - "15672:15672"
    hostname: rabbitmq
    environment: 
        RABBITMQ_ERLANG_COOKIE:
        RABBITMQ_DEFAULT_USER:
        RABBITMQ_DEFAULT_PASS:
        SQUONK_RABBITMQ_VHOST:
        SQUONK_RABBITMQ_USER:
        SQUONK_RABBITMQ_PASS:

################# PostgreSQL container ############################################
db:
    image: squonk/postgres
    ports: 
    - "5432:5432"


################# chem services container #########################################
# available on
# http://${DOCKER_GATEWAY}:9080/chem-services-rdkit-basic/rest/v1/calculators
# http://${DOCKER_GATEWAY}:9080/chem-services-cdk-basic/rest/v1/calculators
# http://${DOCKER_GATEWAY}:9080/chem-services-chemaxon-basic/rest/v1/calculators
# http://${DOCKER_GATEWAY}:9080/chem-services-chemaxon-basic/rest/v1/descriptors
#
# Test using something like this:
# curl -X POST -T mols.json "http://${DOCKER_GATEWAY}:9080/chem-services-cdk-basic/rest/v1/calculators/logp"
#
chemservices:
    image: squonk/chem-services-basic
    ports:
    - "9080:8080"


################# core services container #########################################
# available on:
# http://${DOCKER_GATEWAY}/coreservices/rest/ping
# http://${DOCKER_GATEWAY}/coreservices/rest/v1/services
# http://${DOCKER_GATEWAY}/coreservices/rest/v1/jobs
# 
coreservices:
    image: squonk/core-services
    ports:
    - 80:8080
    links:
    - db:db
    - mq:rabbitmq
    environment:
        SQUONK_RABBITMQ_HOST: rabbitmq
        SQUONK_RABBITMQ_VHOST:
        SQUONK_RABBITMQ_USER:
        SQUONK_RABBITMQ_PASS:
        SQUONK_DB_SERVER: db
        SQUONK_BASIC_CHEM_SERVICES_URL: "http://${DOCKER_GATEWAY}:9080"
#        SQUONK_RDKIT_CHEM_SERVICES_URL



################# swagger container ###############################################
swagger:
    image: sjeandeaux/docker-swagger-ui
    ports:
        - "8888:8888"
    environment: 
        API_URL: http://${DOCKER_GATEWAY}/coreservices/api-docs
        

